const canvas=document.getElementById("space-game"),templates_score=document.getElementById("personal-score"),templates_message=document.getElementById("space-text"),templates_pb=document.getElementById("personal-best"),templates_site_top=document.getElementById("site-best"),templates_site_drifters=document.getElementById("drifters-destroyed"),canvas_rect={left:0,right:canvas.width,top:0,bottom:canvas.height},NUM_STAR=400,DRIFTER_COLOR="#D3D3D3",BEAM_COLORS=["#FFFFFF","#9B30FF","#2a52be"],BASE_SHIP_COLOR="#7CFC00",SHIP_OUTLINE="#FFA500",SHIP_STROKE_SIZE=2,rect=canvas.getBoundingClientRect(),ctx=canvas.getContext("2d"),SPEED=2,CIRCLE_SIZE=2.5,startX=canvas.width/2,startY=canvas.height/2,BASE_SHIP_SIZE=5,DRIFTER_MAX_SIZE=5,POINTS=[1,1,2,3,5],TIME_DELAY=25,DIFFICULTY_INTERVAL=5e3,BASE_DRIFTER_INTERVAL=1e3,DIFFICULTY_STEP=1.1,DRIFTER_SPEED=4.5,SHIP_SPEED=10,SIZE_MOMENTUM=1.3,SIZE_MULT=3,SHIP_MULT=5,MEDIUM_POWER=500,HIGH_POWER=3e3,BEAM_PERSIST=[50,200,500],BEAM_DAMAGE=[1,2,7];var drifters,beams,drifters_destroyed,score,ship_momentum,ship_size,drifter_interval,difficulty_time,drifter_time,ship_x,ship_y,beam_charge,beam_amount,beam_loc,ship_momentum_x,ship_momentum_y,ship_color,game_active=!1,medium_beam_message=!1,high_beam_message=!1;const draw=()=>{if(ctx.clearRect(0,0,canvas.width,canvas.height),game_active){if(difficulty_time>=5e3&&(drifter_interval=Math.ceil(drifter_interval/1.1),difficulty_time=0,templates_message.innerHTML="Difficulty increased"),drifter_time>=drifter_interval&&(drifters.push(gen_drifter()),drifter_time=0),beam_charge)(beam_amount+=25)>3e3?(high_beam_message&&(templates_message.innerHTML="High beam ready",high_beam_message=!1),ship_color=BEAM_COLORS[2]):beam_amount>500?(medium_beam_message&&(templates_message.innerHTML="Medium beam ready",medium_beam_message=!1),ship_color=BEAM_COLORS[1]):ship_color=BEAM_COLORS[0];else if(0!==beam_amount){let e;beam_amount<500?(e=0,templates_message.innerHTML="Small beam fired"):beam_amount<3e3?(e=1,templates_message.innerHTML="Medium beam fired"):(templates_message.innerHTML="High beam fired",e=2),beam_amount=0,ship_color="#7CFC00";let t={power:e,life:BEAM_PERSIST[e],damage:BEAM_DAMAGE[e],x1:ship_x+5*ship_size/2,y1:ship_y+5*ship_size/2,x2:beam_loc.x,y2:beam_loc.y};beams.push(t),propel_ship(t)}draw_sprites(),move_sprites(),check_collisions(),decay_beams(),difficulty_time+=25,drifter_time+=25}else draw_stars(),move_stars()},gen_star=()=>({x:Math.floor(Math.random()*canvas.width),y:Math.floor(Math.random()*canvas.height)}),gen_star_coords=()=>{let e=[];for(let t=0;t<400;t++){let t=gen_star();e.push(t)}return e};var star_arr=gen_star_coords(),star_move=[];const moving=e=>{for(let t=0;t<star_move.length;t++)if(star_move[t].index==e)return!0;return!1},dist=(e,t,r,s)=>Math.sqrt(Math.pow(r-e,2)+Math.pow(s-t,2)),out_of_range=e=>e.x<0||e.y<0||e.x>canvas.width||e.y>canvas.height,draw_stars=()=>{star_arr.forEach(e=>{ctx.beginPath(),ctx.arc(e.x,e.y,2.5,0,2*Math.PI,!1),ctx.fillStyle="white",ctx.fill(),ctx.closePath()})},move_stars=()=>{for(let e=star_move.length-1;e>=0;e--){let t=star_move[e];star_arr[t.index].x+=Math.round(2*Math.cos(t.dir)),star_arr[t.index].y+=Math.round(2*Math.sin(t.dir)),out_of_range(star_arr[t.index])&&(star_arr[t.index]=gen_star(),star_move.splice(e,1))}},setupGame=()=>{drifters=[],beams=[],drifters_destroyed=0,score=0,ship_size=5,drifter_interval=1e3,drifter_time=0,difficulty_time=0,game_active=!0,ship_x=startX,ship_y=startY,ship_momentum_x=0,ship_momentum_y=0,ship_color="#7CFC00",beam_charge=!1,beam_amount=0},gen_drifter=()=>{let e,t,r,s=Math.floor(5*Math.random())+1,i=Math.floor(4*Math.random());return 0==i?(t=1-s,e=Math.floor(Math.random()*canvas.width),r=Math.random()*Math.PI/2+Math.PI/4):1==i?(e=canvas.width-1,t=Math.floor(Math.random()*canvas.height),r=Math.random()*Math.PI/2+Math.PI/2+Math.PI/4):2==i?(t=canvas.height-1,e=Math.floor(Math.random()*canvas.width),r=Math.random()*Math.PI/2+Math.PI+Math.PI/4):(e=1-s,t=Math.floor(Math.random()*canvas.height),r=Math.random()/2-Math.PI/2+Math.PI/4),{x:e,y:t,dir:r,size:s,points:POINTS[s-1]}},draw_sprites=()=>{drifters.forEach(e=>{e.size>0&&e.size<=5&&(ctx.beginPath(),ctx.rect(e.x,e.y,3*e.size,3*e.size),ctx.fillStyle="#D3D3D3",ctx.fill(),ctx.closePath())}),beams.forEach(e=>{if(ctx.beginPath(),ctx.moveTo(e.x1,e.y1),e.x1==e.x2)e.y2>=e.y1?ctx.lineTo(e.x2,canvas.height):ctx.lineTo(e.x2,0);else{let t=(e.y2-e.y1)/(e.x2-e.x1);e.x2>e.x1?ctx.lineTo(canvas.width,e.y1+t*(canvas.width-e.x1)):ctx.lineTo(0,e.y1-1*t*e.x1)}ctx.lineWidth=e.power+1,ctx.strokeStyle=BEAM_COLORS[e.power],ctx.stroke(),ctx.closePath()}),ship_size>0&&(ctx.beginPath(),ctx.rect(ship_x,ship_y,5*ship_size,5*ship_size),ctx.fillStyle=ship_color,ctx.fill(),ctx.strokeStyle="#FFA500",ctx.lineWidth=2,ctx.stroke(),ctx.closePath())},move_sprites=()=>{for(let e=drifters.length-1;e>=0;e--){size_slowdown=1.3*drifters[e].size;let t=4.5*Math.cos(drifters[e].dir)/size_slowdown,r=4.5*Math.sin(drifters[e].dir)/size_slowdown;drifters[e].x+=t,drifters[e].y+=r,drifter_rect={left:drifters[e].x,right:drifters[e].x+3*drifters[e].size,top:drifters[e].y,bottom:drifters[e].y+3*drifters[e].size},(!intersectRect(drifter_rect,canvas_rect)||drifters[e].size<=0||drifters[e].size>5)&&drifters.splice(e,1)}ship_x+=ship_momentum_x/ship_size,ship_y+=ship_momentum_y/ship_size,ship_rect={left:ship_x,right:ship_x+5*ship_size,top:ship_y,bottom:ship_y+5*ship_size},intersectRect(ship_rect,canvas_rect)||gameover("You drifted away!")},propel_ship=e=>{deltaX=e.x2-e.x1,deltaY=e.y2-e.y1,magnitude=Math.sqrt(Math.pow(deltaX,2)+Math.pow(deltaY,2)),0===magnitude&&(magnitude=1),deltaX=e.damage*deltaX/magnitude,deltaY=e.damage*deltaY/magnitude,ship_momentum_x-=deltaX,ship_momentum_y-=deltaY},intersectBeam=(e,t)=>{if(drifter_rect={left:t.x,right:t.x+3*t.size,top:t.y,bottom:t.y+3*t.size},e.x1!=e.x2){let t=(e.y2-e.y1)/(e.x2-e.x1);if(e.x2>e.x1){if(drifter_rect.right<=e.x1)return!1;if(drifter_rect.left<e.x1){let r=e.y1,s=e.y1+t*(drifter_rect.right-e.x1);return crosses(r,s,drifter_rect.bottom,drifter_rect.top)}{let r=e.y1+t*(drifter_rect.left-e.x1),s=e.y1+t*(drifter_rect.right-e.x1);return crosses(r,s,drifter_rect.bottom,drifter_rect.top)}}if(drifter_rect.left>=e.x1)return!1;if(drifter_rect.right>e.x1){let r=e.y1,s=e.y1-t*(e.x1-drifter_rect.left);return crosses(r,s,drifter_rect.bottom,drifter_rect.top)}{let r=e.y1-t*(e.x1-drifter_rect.right),s=e.y1-t*(e.x1-drifter_rect.left);return crosses(r,s,drifter_rect.bottom,drifter_rect.top)}}if(e.y2>=e.y1){if(drifter_rect.bottom>e.y1&&drifter_rect.left<e.x1&&drifter_rect.right>e.x1)return!0}else if(drifter_rect.top<e.y1&&drifter_rect.left<e.x1&&drifter_rect.right>e.x1)return!0;return!1},check_collisions=()=>{let e=!1;ship_rect={left:ship_x,right:ship_x+5*ship_size,top:ship_y,bottom:ship_y+5*ship_size};for(let t=drifters.length-1;t>=0;t--)drifter_rect={left:drifters[t].x,right:drifters[t].x+3*drifters[t].size,top:drifters[t].y,bottom:drifters[t].y+3*drifters[t].size},intersectRect(drifter_rect,ship_rect)&&(e=!0,drifters.splice(t,1));e&&((ship_size-=1)>0?templates_message.innerHTML=`Took damage. Health is at ${ship_size}`:gameover("You were destroyed!"));let t=0,r=0;beams.forEach(e=>{for(let s=drifters.length-1;s>=0;s--)if(intersectBeam(e,drifters[s])){drifters[s].size-=e.damage,drifters[s].size<=0&&(t+=1,r+=drifters[s].points,drifters.splice(s,1))}});let s=Math.pow(t,2)/2-t/2;t>0&&(score+=r+s,templates_score.innerHTML=score,templates_message.innerHTML=s>0?`Scored ${r} points: ${r} points from destroying drifters + ${s} bonus points from a ${t} combo!`:`Scored ${r} points: ${r} points from destroying drifters!`),drifters_destroyed+=t,user&&score>personal_best&&(personal_best=score,templates_pb.innerHTML=personal_best),score>site_best&&(site_best=score,templates_site_top.innerHTML=site_best),site_drifters+=t,templates_site_drifters.innerHTML=site_drifters},decay_beams=()=>{for(let e=beams.length-1;e>=0;e--)beams[e].life-=25,beams[e].life<=0&&beams.splice(e,1)},intersectRect=(e,t)=>!(t.left>e.right||t.right<e.left||t.top>e.bottom||t.bottom<e.top),crosses=(e,t,r,s)=>e>=r&&e<=s||(t>=r&&t<=s||(e<r&&t>s||e>s&&t<r)),gameover=e=>{game_active=!1,templates_message.innerHTML=e+` You scored: ${score}. Game over! Click to play again`,score>0&&$.ajax({url:base_url,cache:"false",dataType:"json",type:"POST",data:{score:score,drifters:drifters_destroyed},beforeSend:function(e){e.setRequestHeader("X-CSRFToken",$.cookie("csrftoken"))},success:function(e){},error:function(e){}})};draw(),setInterval(draw,25),canvas.onmousemove=(e=>{if(!game_active){let t=e.clientX-rect.left,r=e.clientY-rect.top;for(let e=0;e<star_arr.length;e++){let s=star_arr[e];dist(t,r,s.x,s.y)<=15&&!moving(e)&&star_move.push({index:e,dir:Math.random()*Math.PI*2})}}}),canvas.addEventListener("click",e=>{game_active||(drifters=[],beams=[],drifters_destroyed=0,score=0,ship_size=5,drifter_interval=1e3,drifter_time=0,difficulty_time=0,game_active=!0,ship_x=startX,ship_y=startY,ship_momentum_x=0,ship_momentum_y=0,ship_color="#7CFC00",beam_charge=!1,beam_amount=0,templates_message.innerHTML="Hold and click to shoot. Destroy as many drifters as possible",templates_score.innerHTML="0")}),canvas.addEventListener("mousedown",e=>{game_active&&(beam_charge=!0,beam_amount=0,templates_message.innerHTML="Charging beam",medium_beam_message=!0,high_beam_message=!0)}),canvas.addEventListener("mouseup",e=>{game_active&&(beam_charge=!1,beam_loc={x:e.clientX-rect.left,y:e.clientY-rect.top})});